<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Rutas - AGROLLANOS</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librer√≠a para capturar el tiquete como imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body style="padding-top: 20px;">

    <div class="app-container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0"><i class="fa-solid fa-clock-rotate-left"></i> Historial de Rutas</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="exportHistoryCSV()" class="btn-primary small">üì• Exportar Excel</button>
                    <button onclick="window.close()" class="btn-del small">Cerrar P√°gina</button>
                </div>
            </div>
            
            <div class="grid-4" style="margin-bottom:20px; background: rgba(0,0,0,0.1); padding: 15px; border-radius: 8px;">
                <div><label>Desde</label><input type="date" id="histIni"></div>
                <div><label>Hasta</label><input type="date" id="histFin"></div>
                <div><label>Veh√≠culo</label><select id="histPlaca"><option value="">Todos</option></select></div>
                <div><label>Conductor</label><select id="histCond"><option value="">Todos</option></select></div>
            </div>

            <div class="table-responsive" style="min-height: 400px;">
                <table id="tableHistory">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Ruta</th>
                            <th>Veh√≠culo</th>
                            <th>Conductor</th>
                            <th>Kg Reales</th>
                            <th>Comisi√≥n</th>
                            <th>Gastos</th>
                            <th>Total</th>
                            <th>Foto</th>
                            <th>Tiquete</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="10" style="text-align:center; padding:50px;">Cargando historial...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="hist-summary" style="margin-top:20px; border-top: 2px solid var(--primary); padding-top:20px;">
                <div class="sum-item">Rutas: <span id="hCount" style="font-weight:bold; color:var(--primary);">0</span></div>
                <div class="sum-item">Kg Entregados: <span id="hKg" style="font-weight:bold; color:var(--primary);">0</span></div>
                <div class="sum-item">Total Pagado: <span id="hComision" style="font-weight:bold; color:var(--green); font-size:1.2rem;">$ 0</span></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="btnPrevHist" class="btn-sec small" disabled>Ant.</button>
                    <span id="pageIndicator" style="font-size:0.8rem;">P√°gina 1</span>
                    <button id="btnNextHist" class="btn-sec small" disabled>Sig.</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VISTA TICKET -->
    <div id="modalTicket" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="max-width: 400px;">
            <h3 style="text-align:center;">Detalle de Manifiesto</h3>
            <!-- Contenedor del tiquete con fondo blanco expl√≠cito para la captura -->
            <div id="ticketPreviewContent" class="ticket-preview-box" style="background: white; color: black; padding: 20px;"></div>
            <div class="modal-footer" style="justify-content: center; flex-wrap: wrap; gap: 10px;">
                <button onclick="printTicket()" class="btn-primary" style="background:#10b981; flex: 1; min-width: 120px;">üñ®Ô∏è Imprimir</button>
                <button onclick="downloadTicketImage()" class="btn-primary" style="background:#6366f1; flex: 1; min-width: 120px;">üì∏ Capturar</button>
                <button onclick="document.getElementById('modalTicket').style.display='none'" class="btn-sec" style="flex: 1; min-width: 120px;">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('sidma_user'));
        let historyData = [];
        let filteredData = [];
        let curPage = 1;
        const itemsPerPage = 10;

        const LOCALE = 'es-CO';
        const TIMEZONE = 'America/Bogota';
        const fmtMoney = new Intl.NumberFormat(LOCALE, { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
        const fmtNum = new Intl.NumberFormat(LOCALE, { minimumFractionDigits: 0, maximumFractionDigits: 2 });

        const fmtDate = (iso) => { 
            if(!iso) return ''; 
            if(iso.includes('-') && !iso.includes('T')) { 
                const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; 
            }
            try { return new Date(iso).toLocaleDateString(LOCALE, { timeZone: TIMEZONE }); } catch { return iso; }
        };

        // Inicializar fechas con el mes actual
        function initDateFilters() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const toISO = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('histIni').value = toISO(firstDay);
            document.getElementById('histFin').value = toISO(lastDay);
        }

        async function loadHistory() {
            initDateFilters();
            try {
                const res = await fetch('/api/historial');
                historyData = await res.json();
                
                const placas = [...new Set(historyData.map(r => r.placa_vehiculo))];
                const conds = [...new Set(historyData.map(r => r.conductor_asignado))];
                
                const sP = document.getElementById('histPlaca');
                placas.forEach(p => sP.innerHTML += `<option value="${p}">${p}</option>`);
                
                const sC = document.getElementById('histCond');
                conds.forEach(c => sC.innerHTML += `<option value="${c}">${c}</option>`);

                if(user && user.rol === 'conductor') {
                    sC.value = user.nombre;
                    sC.disabled = true;
                }

                applyFilters();
            } catch (e) { console.error(e); }
        }

        function applyFilters() {
            const ini = document.getElementById('histIni').value;
            const fin = document.getElementById('histFin').value;
            const placa = document.getElementById('histPlaca').value;
            const cond = document.getElementById('histCond').value;

            filteredData = historyData.filter(r => {
                const date = (r.fecha_entrega || r.fecha).split('T')[0];
                const matchDate = (!ini || date >= ini) && (!fin || date <= fin);
                const matchPlaca = !placa || r.placa_vehiculo === placa;
                const matchCond = !cond || r.conductor_asignado === cond;
                return matchDate && matchPlaca && matchCond;
            });

            curPage = 1;
            renderTable();
        }

        function renderTable() {
            const start = (curPage - 1) * itemsPerPage;
            const pageItems = filteredData.slice(start, start + itemsPerPage);
            const tbody = document.querySelector('#tableHistory tbody');
            tbody.innerHTML = '';

            let totalKg = 0; let totalPagos = 0;
            
            filteredData.forEach(r => {
                totalKg += parseFloat(r.total_kg_entregados_real) || 0;
                totalPagos += parseFloat(r.total_pagar_conductor) || 0;
            });

            pageItems.forEach(r => {
                const gastos = JSON.parse(r.gastos_adicionales || '[]');
                const totalGasto = gastos.reduce((s, g) => s + (parseFloat(g.val) || 0), 0);
                const kg = parseFloat(r.total_kg_entregados_real) || 0;
                const total = parseFloat(r.total_pagar_conductor) || 0;
                const comision = total - totalGasto;

                tbody.innerHTML += `<tr>
                    <td>${fmtDate(r.fecha_entrega || r.fecha)}</td>
                    <td>${r.nombre_ruta}</td>
                    <td>${r.placa_vehiculo}</td>
                    <td>${r.conductor_asignado}</td>
                    <td>${fmtNum.format(kg)}</td>
                    <td>${fmtMoney.format(comision)}</td>
                    <td>${fmtMoney.format(totalGasto)}</td>
                    <td><strong>${fmtMoney.format(total)}</strong></td>
                    <td>
                        ${r.evidencia_foto ? 
                            `<button onclick="Swal.fire({imageUrl: '${r.evidencia_foto}', imageAlt: 'Evidencia', showConfirmButton: false, showCloseButton: true})" class="btn-sec small">
                                <i class="fa-solid fa-camera"></i>
                            </button>` : '---'}
                    </td>
                    <td><button onclick="verTicket('${r.id}')" class="btn-sec small">üñ®Ô∏è</button></td>
                </tr>`;
            });

            document.getElementById('hCount').innerText = filteredData.length;
            document.getElementById('hKg').innerText = fmtNum.format(totalKg);
            document.getElementById('hComision').innerText = fmtMoney.format(totalPagos);
            
            document.getElementById('pageIndicator').innerText = `P√°gina ${curPage} de ${Math.ceil(filteredData.length/itemsPerPage) || 1}`;
            document.getElementById('btnPrevHist').disabled = curPage === 1;
            document.getElementById('btnNextHist').disabled = curPage >= Math.ceil(filteredData.length/itemsPerPage);
        }

        function verTicket(id) {
            const r = historyData.find(x => String(x.id) === String(id));
            if(!r) return;
            
            const detalles = JSON.parse(r.detalles_clientes_json || '[]');
            const gastos = JSON.parse(r.gastos_adicionales || '[]');
            
            let list = '';
            detalles.forEach(c => {
                list += `<div style="border-bottom:1px solid #000; padding:5px 0; margin-top:5px;">
                            <strong>${c.cliente.toUpperCase()}</strong>
                            ${c.orden ? ` <span style="font-size:10px;">(Ord: ${c.orden})</span>` : ''}
                         </div>`;
                c.productos.forEach(p => {
                    const ent = parseFloat(p.kg_ent) || 0;
                    const plan = parseFloat(p.kg_plan) || 0;
                    const esParcial = ent < plan;
                    
                    list += `<div style="display:flex; justify-content:space-between; font-size:11px; padding: 2px 0;">
                                <span>- ${p.producto}</span>
                                <span style="${esParcial ? 'color: red; font-weight: bold;' : ''}">
                                    ${fmtNum.format(ent)} ${esParcial ? `/ ${fmtNum.format(plan)}` : ''} Kg
                                </span>
                             </div>`;
                });
            });

            let gastosDetalle = '';
            let totalGasto = 0;
            if (gastos.length > 0) {
                gastosDetalle = `<div style="margin-top:10px; border-top: 1px dashed #666; padding-top:5px;">`;
                gastos.forEach(g => {
                    const val = parseFloat(g.val) || 0;
                    totalGasto += val;
                    gastosDetalle += `<div style="display:flex; justify-content:space-between; font-size:10px; color: #555;">
                                        <span>   ‚Ä¢ ${g.desc}:</span><span>${fmtMoney.format(val)}</span>
                                      </div>`;
                });
                gastosDetalle += `</div>`;
            }

            const totalPagado = parseFloat(r.total_pagar_conductor) || 0;
            const comision = totalPagado - totalGasto;

            document.getElementById('ticketPreviewContent').innerHTML = `
                <div style="text-align:center;">
                    <h2 style="margin-bottom:5px;">AGROLLANOS</h2>
                    <p style="margin:0; font-size:11px;">MANIFIESTO FINALIZADO #${r.id.toString().slice(-4)}</p>
                </div>
                <div style="font-size:12px; margin-top:10px;">
                    <div style="display:flex; justify-content:space-between;"><span>Fecha Ent:</span><span>${fmtDate(r.fecha_entrega || r.fecha)}</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Conductor:</span><strong>${r.conductor_asignado}</strong></div>
                    <div style="display:flex; justify-content:space-between;"><span>Placa:</span><span>${r.placa_vehiculo}</span></div>
                </div>
                <hr style="border:none; border-top:1px solid #000; margin:10px 0;">
                ${list}
                <hr style="border:none; border-top:1px solid #000; margin:10px 0;">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>TOTAL CARGA REAL:</span><span>${fmtNum.format(r.total_kg_entregados_real)} Kg</span>
                </div>
                
                ${r.observaciones ? `<div style="font-size:11px; margin-top:8px; background:#f8fafc; padding:8px; border-left: 3px solid var(--orange); color: #334155;"><strong>Observaciones:</strong> ${r.observaciones}</div>` : ''}

                <div style="margin-top:10px; padding-top:5px; border-top:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between; font-size:11px;">
                        <span>Comisi√≥n Ruta:</span><span>${fmtMoney.format(comision)}</span>
                    </div>
                    ${gastosDetalle}
                    <div style="display:flex; justify-content:space-between; color:green; font-weight:bold; font-size:14px; margin-top:5px; border-top:1px double #000; padding-top:3px;">
                        <span>PAGO TOTAL:</span><span>${fmtMoney.format(totalPagado)}</span>
                    </div>
                </div>
            `;
            document.getElementById('modalTicket').style.display = 'flex';
        }

        /**
         * Funci√≥n para imprimir el tiquete optimizado para 80mm
         */
        function printTicket() {
            const content = document.getElementById('ticketPreviewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Imprimir Tiquete</title>
                        <style>
                            @page { margin: 0; }
                            body { 
                                font-family: 'Courier New', monospace; 
                                width: 80mm; 
                                margin: 0; 
                                padding: 5mm; 
                                font-size: 12px;
                                color: black;
                            }
                            h2 { text-align: center; font-size: 16px; margin: 0 0 5px 0; }
                            p { text-align: center; margin: 0 0 10px 0; font-size: 10px; }
                            hr { border: none; border-top: 1px dashed black; margin: 10px 0; }
                            div { margin-bottom: 2px; }
                            strong { font-weight: bold; }
                            .flex { display: flex; justify-content: space-between; }
                            .obs-box { 
                                margin-top: 5px; 
                                padding: 5px; 
                                border: 1px solid black; 
                                font-size: 11px; 
                            }
                        </style>
                    </head>
                    <body onload="window.print(); window.close();">
                        ${content}
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        /**
         * Funci√≥n para capturar el contenido del tiquete y descargarlo como imagen
         */
        async function downloadTicketImage() {
            const ticketElement = document.getElementById('ticketPreviewContent');
            if(!ticketElement) return;

            // Mostrar cargando
            Swal.fire({
                title: 'Generando imagen...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const canvas = await html2canvas(ticketElement, {
                    scale: 2, // Mejor resoluci√≥n
                    backgroundColor: "#ffffff",
                    useCORS: true,
                    logging: false
                });

                const imgData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `tiquete_agrollanos_${Date.now()}.png`;
                link.href = imgData;
                link.click();
                
                Swal.close();
            } catch (error) {
                console.error("Error capturando tiquete:", error);
                Swal.fire('Error', 'No se pudo generar la imagen del tiquete', 'error');
            }
        }

        function exportHistoryCSV() {
            let csv = "\uFEFFFecha;Ruta;Placa;Conductor;Kg Planificados;Kg Entregados;Comisi√≥n;Gastos;Total Pago\n";
            filteredData.forEach(r => {
                const gastos = JSON.parse(r.gastos_adicionales || '[]');
                const totalGasto = gastos.reduce((s, g) => s + (parseFloat(g.val) || 0), 0);
                const kgEnt = parseFloat(r.total_kg_entregados_real) || 0;
                const kgPlan = parseFloat(r.total_kg_ruta) || 0;
                const total = parseFloat(r.total_pagar_conductor) || 0;
                const comision = total - totalGasto;

                const row = [
                    fmtDate(r.fecha_entrega || r.fecha),
                    r.nombre_ruta,
                    r.placa_vehiculo,
                    r.conductor_asignado,
                    kgPlan,
                    kgEnt,
                    comision,
                    totalGasto,
                    total
                ];
                csv += row.join(";") + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `historial_agrollanos_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        document.getElementById('btnPrevHist').onclick = () => { if(curPage > 1) { curPage--; renderTable(); } };
        document.getElementById('btnNextHist').onclick = () => { if(curPage < Math.ceil(filteredData.length/itemsPerPage)) { curPage++; renderTable(); } };
        document.querySelectorAll('input, select').forEach(el => el.onchange = applyFilters);

        window.onload = loadHistory;
    </script>
</body>
</html>