<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Rutas - AGROLLANOS</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librer칤a para capturar imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .hist-container { max-width: 1000px; margin: 0 auto; padding: 15px; }
        .filter-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px; background: var(--card); padding: 15px;
            border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px;
        }
        .table-wrapper { background: var(--card); border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: rgba(59, 130, 246, 0.1); color: var(--primary); text-align: left; padding: 12px; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); color: #cbd5e1; }
        
        /* Modal Tiquete Pro */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); justify-content: center; align-items: center;
            z-index: 10000; padding: 10px;
        }
        .modal-box {
            background: var(--card); border-radius: 15px; width: 100%; max-width: 420px;
            padding: 20px; border: 1px solid var(--border); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
        }
        .ticket-capture-area {
            background: white; padding: 10px; border-radius: 4px; margin: 10px 0;
        }
        .ticket-wrapper {
            background: white; color: black; padding: 15px; border-radius: 2px;
            font-family: 'Courier New', Courier, monospace;
            max-height: 60vh; overflow-y: auto; border: 1px solid #ddd;
        }
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 15px; border: 1px solid var(--border); border-radius: 10px; background: var(--card); padding: 10px; }
            td { border: none; position: relative; padding-left: 50% !important; text-align: right; min-height: 35px; }
            td:before { 
                position: absolute; left: 12px; width: 45%; padding-right: 10px; 
                text-align: left; font-weight: bold; color: var(--primary); content: attr(data-label); 
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand" style="display: flex; align-items: center; gap: 15px;">
            <!-- Bot칩n para regresar atr치s -->
            <button onclick="window.location.href='index.html'" class="btn-sec small" style="color: white; border-color: #444;">
                <i class="fa-solid fa-arrow-left"></i> ATR츼S
            </button>
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-house"></i> AGROLLANOS
            </div>
        </div>
        <div id="userBadge" style="font-size: 0.8rem; background: var(--primary); padding: 4px 10px; border-radius: 20px;">Cargando...</div>
    </header>

    <div class="hist-container">
        <div class="filter-bar">
            <input type="date" id="histIni" onchange="applyFilters()">
            <input type="date" id="histFin" onchange="applyFilters()">
            <input type="text" id="histSearch" placeholder="Buscar placa/ruta/conductor..." oninput="applyFilters()">
            <button onclick="exportDetailedCSV()" class="btn-sec"><i class="fa-solid fa-file-excel"></i> CSV</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Ruta</th>
                        <th>Veh칤culo</th>
                        <th>Conductor</th>
                        <th>Kg Reales</th>
                        <th style="text-align: center;">Acci칩n</th>
                    </tr>
                </thead>
                <tbody id="tbodyHistory"></tbody>
            </table>
        </div>
        <div id="noRecords" style="display:none; text-align:center; padding:50px; color:#64748b;">No hay registros disponibles.</div>
    </div>

    <!-- MODAL TIQUETE FINALIZADO -->
    <div id="modalTicket" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;"><i class="fa-solid fa-receipt"></i> Manifiesto Finalizado</h3>
                <button onclick="closeModal('modalTicket')" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div id="ticketCaptureArea" class="ticket-capture-area">
                <div id="ticketPreviewContent" class="ticket-wrapper"></div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="sendWhatsAppTicket()" class="btn-primary" style="background:#22c55e; border:none; width:100%;">
                    <i class="fa-brands fa-whatsapp"></i> ENVIAR A WHATSAPP
                </button>
                <div class="actions-grid">
                    <button onclick="printNow()" class="btn-sec" style="color:white; border-color:var(--border);">
                        <i class="fa-solid fa-print"></i> IMPRIMIR
                    </button>
                    <button onclick="downloadTicketImage()" class="btn-sec" style="color:white; border-color:var(--border);">
                        <i class="fa-solid fa-image"></i> CAPTURAR
                    </button>
                </div>
                <button onclick="closeModal('modalTicket')" class="btn-del" style="width:100%; margin-top:5px;">CERRAR</button>
            </div>
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('sidma_user'));
        let historyData = [];
        let currentTicketRoute = null;

        const LOCALE = 'es-CO';
        const fmtMoney = new Intl.NumberFormat(LOCALE, { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
        const fmtNum = new Intl.NumberFormat(LOCALE, { minimumFractionDigits: 0, maximumFractionDigits: 2 });

        async function loadHistory() {
            if(!user) { window.location.href = 'index.html'; return; }
            document.getElementById('userBadge').textContent = `${user.nombre} (${user.rol.toUpperCase()})`;

            try {
                const res = await fetch('/api/historial');
                const raw = await res.json();
                
                let processed = raw.map(r => {
                    let item = {};
                    for(let k in r) item[k.toLowerCase().trim()] = r[k];
                    try { item.detalles = JSON.parse(item.detalles_clientes_json); } catch { item.detalles = []; }
                    try { item.gastos = JSON.parse(item.gastos_adicionales); } catch { item.gastos = []; }
                    return item;
                });

                if(user.rol === 'conductor') {
                    processed = processed.filter(r => r.conductor_asignado === user.nombre);
                }

                historyData = processed.sort((a, b) => new Date(b.fecha_entrega || b.fecha) - new Date(a.fecha_entrega || a.fecha));
                applyFilters();
            } catch (e) { console.error("Error cargando historial:", e); }
        }

        function applyFilters() {
            const ini = document.getElementById('histIni').value;
            const fin = document.getElementById('histFin').value;
            const search = document.getElementById('histSearch').value.toLowerCase();

            const filtered = historyData.filter(r => {
                const dateStr = (r.fecha_entrega || r.fecha || '').split('T')[0];
                const matchDate = (!ini || dateStr >= ini) && (!fin || dateStr <= fin);
                const matchSearch = !search || 
                    (r.placa_vehiculo || '').toLowerCase().includes(search) || 
                    (r.nombre_ruta || '').toLowerCase().includes(search) ||
                    (r.conductor_asignado || '').toLowerCase().includes(search);
                return matchDate && matchSearch;
            });

            renderTable(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tbodyHistory');
            const noRec = document.getElementById('noRecords');
            tbody.innerHTML = '';
            if(data.length === 0) { noRec.style.display = 'block'; return; }
            noRec.style.display = 'none';

            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="ID">#${String(r.id).slice(-4)}</td>
                    <td data-label="Fecha">${new Date(r.fecha_entrega || r.fecha).toLocaleDateString()}</td>
                    <td data-label="Ruta"><strong>${r.nombre_ruta || '--'}</strong></td>
                    <td data-label="Veh칤culo">${r.placa_vehiculo || '--'}</td>
                    <td data-label="Conductor">${r.conductor_asignado || '--'}</td>
                    <td data-label="Kg Reales">${fmtNum.format(r.total_kg_entregados_real || 0)} Kg</td>
                    <td data-label="Acci칩n" style="text-align: center;">
                        <button onclick="viewTicket('${r.id}')" class="btn-sec" style="padding: 5px 12px; font-size: 0.8rem;">
                            <i class="fa-solid fa-eye"></i> VER
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function viewTicket(id) {
            const r = historyData.find(x => String(x.id) === String(id));
            if(!r) return;
            currentTicketRoute = r;

            let prodsHTML = '';
            (r.detalles || []).forEach(c => {
                prodsHTML += `<div style="margin-top:8px; border-bottom:1px solid #eee; padding-bottom:4px;">
                    <strong>${c.cliente.toUpperCase()}</strong> (Ord: ${c.orden || 'S/N'})<br>`;
                (c.productos || []).forEach(p => {
                    prodsHTML += `<div style="display:flex; justify-content:space-between; font-size:11px;">
                        <span>- ${p.producto}</span><span>${fmtNum.format(p.kg_ent || p.kg_plan)} Kg</span>
                    </div>`;
                });
                prodsHTML += `</div>`;
            });

            const tar = parseFloat(r.valor_tarifa) || 0;
            const kgEnt = parseFloat(r.total_kg_entregados_real) || 0;
            const comision = (r.tipo_comision === 'variable') ? (kgEnt * tar) : tar;
            const totalGastos = (r.gastos || []).reduce((acc, g) => acc + (parseFloat(g.val) || 0), 0);
            const totalPago = parseFloat(r.total_pagar_conductor) || (comision + totalGastos);

            // Preparar el HTML de la foto si existe
            let evidenciaHTML = r.evidencia_foto ? `
                <div style="margin-top:15px; text-align:center; border-top:1px dashed #000; padding-top:10px;">
                    <div style="font-size:10px; margin-bottom:5px;"><b>EVIDENCIA FOTOGR츼FICA:</b></div>
                    <img src="${r.evidencia_foto}" style="max-width:100%; border-radius:4px; border:1px solid #ddd;">
                </div>
            ` : '';

            document.getElementById('ticketPreviewContent').innerHTML = `
                <div style="text-align:center;"><h2 style="margin:0">AGROLLANOS</h2><p style="margin:2px 0; font-size:10px;">NIT: 900.000.000-1</p></div>
                <hr style="border:none; border-top:1px dashed #000;">
                <div style="font-size:11px;">
                    <b>MANIFIESTO:</b> #${String(r.id).slice(-4)}<br>
                    <b>FECHA CIERRE:</b> ${new Date(r.fecha_entrega || r.fecha).toLocaleString()}<br>
                    <b>RUTA:</b> ${r.nombre_ruta}<br>
                    <b>CONDUCTOR:</b> ${r.conductor_asignado}<br>
                    <b>PLACA:</b> ${r.placa_vehiculo}
                </div>
                <hr style="border:none; border-top:1px dashed #000;">
                ${prodsHTML}
                <div style="margin-top:10px; font-size:12px; font-weight:bold; display:flex; justify-content:space-between;">
                    <span>TOTAL CARGA:</span><span>${fmtNum.format(kgEnt)} Kg</span>
                </div>
                <hr style="border:none; border-top:1px dashed #000;">
                <div style="font-size:11px;">
                    <div style="display:flex; justify-content:space-between;"><span>Comisi칩n:</span><span>${fmtMoney.format(comision)}</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Gastos:</span><span>${fmtMoney.format(totalGastos)}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:bold; margin-top:5px;">
                        <span>TOTAL PAGO:</span><span>${fmtMoney.format(totalPago)}</span>
                    </div>
                </div>
                ${evidenciaHTML}
                <div style="margin-top:15px; text-align:center; font-size:9px; color:#666;">--- DOCUMENTO FINALIZADO ---</div>
            `;
            document.getElementById('modalTicket').style.display = 'flex';
        }

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.downloadTicketImage = () => {
            const area = document.getElementById('ticketCaptureArea');
            if(!area) return;

            Swal.fire({ title: 'Generando imagen...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
            
            setTimeout(() => {
                html2canvas(area, { 
                    scale: 3, 
                    backgroundColor: "#ffffff",
                    logging: false,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Tiquete_Cierre_${String(currentTicketRoute.id).slice(-4)}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    Swal.close();
                    // Cerrar vista previa autom치ticamente tras captura
                    closeModal('modalTicket');
                }).catch(err => {
                    console.error("Error captura:", err);
                    Swal.fire('Error', 'No se pudo generar la imagen', 'error');
                });
            }, 500);
        };

        window.printNow = () => {
            const content = document.getElementById('ticketPreviewContent').innerHTML;
            const printWindow = window.open('', '_blank', 'width=400,height=600');
            printWindow.document.write(`<html><head><style>body{width:76mm;margin:0;padding:5mm;font-family:monospace;font-size:12px;color:black;}h2{text-align:center;margin:0;}hr{border:none;border-top:1px dashed black;margin:5px 0;}img{max-width:100%;}</style></head><body onload="window.print();window.close();">${content}</body></html>`);
            printWindow.document.close();
        };

        window.sendWhatsAppTicket = () => {
            const r = currentTicketRoute;
            let msg = `*AGROLLANOS - MANIFIESTO #${String(r.id).slice(-4)}*\n`;
            msg += `游늰 Fecha Cierre: ${new Date(r.fecha_entrega || r.fecha).toLocaleDateString()}\n`;
            msg += `游늸 Ruta: ${r.nombre_ruta}\n`;
            msg += `丘뒲잺 Total Real: ${fmtNum.format(r.total_kg_entregados_real)} Kg\n`;
            msg += `游눯 Pago Conductor: ${fmtMoney.format(r.total_pagar_conductor)}\n`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
        };

        function exportDetailedCSV() {
            let csv = "ID;Fecha;Ruta;Vehiculo;Conductor;Kg Reales;Total Pago\n";
            historyData.forEach(r => {
                csv += `${r.id};${new Date(r.fecha_entrega || r.fecha).toLocaleDateString()};${r.nombre_ruta};${r.placa_vehiculo};${r.conductor_asignado};${r.total_kg_entregados_real};${r.total_pagar_conductor}\n`;
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Historial_Agrollanos.csv";
            link.click();
        }

        window.onload = loadHistory;
    </script>
</body>
</html>