<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historial de Rutas - AGROLLANOS</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Librer√≠a para capturar el tiquete como imagen -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* Estilos para adaptabilidad m√≥vil del historial */
.grid-filters-mobile {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 10px;
margin-bottom: 20px;
background: rgba(255, 255, 255, 0.05);
padding: 15px;
border-radius: 8px;
}

    @media (max-width: 768px) {
        .grid-filters-mobile { grid-template-columns: 1fr; }
        
        /* Transformaci√≥n de tabla a tarjetas en m√≥viles */
        table#tableHistory, 
        table#tableHistory thead, 
        table#tableHistory tbody, 
        table#tableHistory th, 
        table#tableHistory td, 
        table#tableHistory tr { 
            display: block; 
        }
        
        table#tableHistory thead tr { 
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        table#tableHistory tr { 
            border: 1px solid var(--border);
            margin-bottom: 15px;
            background: var(--card);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table#tableHistory td { 
            border: none;
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            position: relative;
            padding-left: 45%; 
            text-align: right;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 14px;
        }
        
        table#tableHistory td:last-child { border-bottom: none; padding-top: 10px; }

        table#tableHistory td:before { 
            position: absolute;
            left: 10px;
            width: 40%; 
            white-space: nowrap;
            text-align: left;
            font-weight: bold;
            color: var(--orange);
            content: attr(data-label);
        }

        .hist-summary {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .modal-box { width: 95%; padding: 15px; }
    }

    .ticket-preview-box {
        background: white;
        color: black;
        font-family: 'Courier New', monospace;
        padding: 15px;
        border-radius: 2px;
        line-height: 1.2;
    }
</style>


</head>
<body style="padding-top: 20px;">

<div class="app-container">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap: 10px;">
            <h2 style="margin:0"><i class="fa-solid fa-clock-rotate-left"></i> Historial de Rutas</h2>
            <div style="display:flex; gap:8px;">
                <button onclick="exportHistoryCSV()" class="btn-primary small">üì• Exportar Excel</button>
                <button onclick="window.close()" class="btn-del small">Cerrar P√°gina</button>
            </div>
        </div>
        
        <div class="grid-filters-mobile">
            <div><label>Desde</label><input type="date" id="histIni"></div>
            <div><label>Hasta</label><input type="date" id="histFin"></div>
            <div><label>Veh√≠culo</label><select id="histPlaca"><option value="">Todos</option></select></div>
            <div><label>Conductor</label><select id="histCond"><option value="">Todos</option></select></div>
        </div>

        <div class="table-responsive" style="min-height: 400px;">
            <table id="tableHistory">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Ruta</th>
                        <th>Veh√≠culo</th>
                        <th>Conductor</th>
                        <th>Kg Reales</th>
                        <th>Comisi√≥n</th>
                        <th>Gastos</th>
                        <th>Total</th>
                        <th>Foto</th>
                        <th>Tiquete</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="10" style="text-align:center; padding:50px;">Cargando historial...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="hist-summary" style="margin-top:20px; border-top: 2px solid var(--primary); padding-top:20px; display:flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="sum-item">Rutas: <span id="hCount" style="font-weight:bold; color:var(--primary);">0</span></div>
                <div class="sum-item">Kg Entregados: <span id="hKg" style="font-weight:bold; color:var(--primary);">0</span></div>
            </div>
            <div id="hComision" style="font-weight:bold; color:var(--green); font-size:1.2rem;">$ 0</div>
            <div style="display:flex; align-items:center; gap:8px;">
                <button id="btnPrevHist" class="btn-sec small" disabled><i class="fa-solid fa-chevron-left"></i></button>
                <span id="pageIndicator" style="font-size:0.8rem; font-weight: bold;">P√°gina 1</span>
                <button id="btnNextHist" class="btn-sec small" disabled><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL VISTA TICKET -->
<div id="modalTicket" class="modal-overlay" style="display:none;">
    <div class="modal-box" style="max-width: 400px;">
        <h3 style="text-align:center; margin-top:0;">Detalle de Manifiesto</h3>
        <div id="ticketPreviewContent" class="ticket-preview-box"></div>
        <div class="modal-footer" style="justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
            <button onclick="printTicket()" class="btn-primary" style="background:#10b981; flex: 1; min-width: 120px;">üñ®Ô∏è Imprimir</button>
            <button onclick="downloadTicketImage()" class="btn-primary" style="background:#6366f1; flex: 1; min-width: 120px;">üì∏ Capturar</button>
            <button onclick="document.getElementById('modalTicket').style.display='none'" class="btn-sec" style="flex: 1; min-width: 120px;">Cerrar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const user = JSON.parse(localStorage.getItem('sidma_user'));
    let historyData = [];
    let filteredData = [];
    let curPage = 1;
    const itemsPerPage = 10;

    const LOCALE = 'es-CO';
    const TIMEZONE = 'America/Bogota';
    const fmtMoney = new Intl.NumberFormat(LOCALE, { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
    const fmtNum = new Intl.NumberFormat(LOCALE, { minimumFractionDigits: 0, maximumFractionDigits: 2 });

    const fmtDate = (iso) => { 
        if(!iso) return ''; 
        if(iso.includes('-') && !iso.includes('T')) { 
            const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; 
        }
        try { return new Date(iso).toLocaleDateString(LOCALE, { timeZone: TIMEZONE }); } catch { return iso; }
    };

    function initDateFilters() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const toISO = (d) => d.toISOString().split('T')[0];
        document.getElementById('histIni').value = toISO(firstDay);
        document.getElementById('histFin').value = toISO(lastDay);
    }

    async function loadHistory() {
        initDateFilters();
        try {
            const res = await fetch('/api/historial');
            historyData = await res.json();
            
            const placas = [...new Set(historyData.map(r => r.placa_vehiculo))];
            const conds = [...new Set(historyData.map(r => r.conductor_asignado))];
            
            const sP = document.getElementById('histPlaca');
            placas.forEach(p => sP.innerHTML += `<option value="${p}">${p}</option>`);
            const sC = document.getElementById('histCond');
            conds.forEach(c => sC.innerHTML += `<option value="${c}">${c}</option>`);

            if(user && user.rol === 'conductor') {
                sC.value = user.nombre;
                sC.disabled = true;
            }
            applyFilters();
        } catch (e) { console.error(e); }
    }

    function applyFilters() {
        const ini = document.getElementById('histIni').value;
        const fin = document.getElementById('histFin').value;
        const placa = document.getElementById('histPlaca').value;
        const cond = document.getElementById('histCond').value;

        filteredData = historyData.filter(r => {
            const date = (r.fecha_entrega || r.fecha).split('T')[0];
            return (!ini || date >= ini) && (!fin || date <= fin) &&
                   (!placa || r.placa_vehiculo === placa) &&
                   (!cond || r.conductor_asignado === cond);
        });

        curPage = 1;
        renderTable();
    }

    function renderTable() {
        const start = (curPage - 1) * itemsPerPage;
        const pageItems = filteredData.slice(start, start + itemsPerPage);
        const tbody = document.querySelector('#tableHistory tbody');
        tbody.innerHTML = '';

        let totalKg = 0; let totalPagos = 0;
        filteredData.forEach(r => {
            totalKg += parseFloat(r.total_kg_entregados_real) || 0;
            totalPagos += parseFloat(r.total_pagar_conductor) || 0;
        });

        pageItems.forEach(r => {
            const gastos = JSON.parse(r.gastos_adicionales || '[]');
            const totalGasto = gastos.reduce((s, g) => s + (parseFloat(g.val) || 0), 0);
            const kg = parseFloat(r.total_kg_entregados_real) || 0;
            const total = parseFloat(r.total_pagar_conductor) || 0;
            const comision = total - totalGasto;

            tbody.innerHTML += `<tr>
                <td data-label="Fecha">${fmtDate(r.fecha_entrega || r.fecha)}</td>
                <td data-label="Ruta">${r.nombre_ruta}</td>
                <td data-label="Veh√≠culo">${r.placa_vehiculo}</td>
                <td data-label="Conductor">${r.conductor_asignado}</td>
                <td data-label="Kg Reales">${fmtNum.format(kg)}</td>
                <td data-label="Comisi√≥n">${fmtMoney.format(comision)}</td>
                <td data-label="Gastos">${fmtMoney.format(totalGasto)}</td>
                <td data-label="Total"><strong>${fmtMoney.format(total)}</strong></td>
                <td data-label="Foto">
                    ${r.evidencia_foto ? 
                        `<button onclick="Swal.fire({imageUrl: '${r.evidencia_foto}', imageAlt: 'Evidencia', showConfirmButton: false})" class="btn-sec small">üì∏</button>` : '---'}
                </td>
                <td data-label="Tiquete"><button onclick="verTicket('${r.id}')" class="btn-sec small">üñ®Ô∏è</button></td>
            </tr>`;
        });

        document.getElementById('hCount').innerText = filteredData.length;
        document.getElementById('hKg').innerText = fmtNum.format(totalKg);
        document.getElementById('hComision').innerText = fmtMoney.format(totalPagos);
        
        const totalPages = Math.ceil(filteredData.length/itemsPerPage) || 1;
        document.getElementById('pageIndicator').innerText = `P√°gina ${curPage} de ${totalPages}`;
        document.getElementById('btnPrevHist').disabled = curPage === 1;
        document.getElementById('btnNextHist').disabled = curPage >= totalPages;
    }

    function verTicket(id) {
        const r = historyData.find(x => String(x.id) === String(id));
        if(!r) return;
        const detalles = JSON.parse(r.detalles_clientes_json || '[]');
        let list = '';
        detalles.forEach(c => {
            list += `<div style="border-bottom:1px solid #000; padding:4px 0; margin-top:5px;">
                        <strong>${c.cliente.toUpperCase()}</strong> ${c.orden ? `<small>(Ord: ${c.orden})</small>` : ''}
                     </div>`;
            c.productos.forEach(p => {
                const ent = parseFloat(p.kg_ent) || 0;
                list += `<div style="display:flex; justify-content:space-between; font-size:11px;">
                            <span>- ${p.producto}</span><span>${fmtNum.format(ent)} Kg</span>
                         </div>`;
            });
        });

        const totalPagado = parseFloat(r.total_pagar_conductor) || 0;

        document.getElementById('ticketPreviewContent').innerHTML = `
            <div style="text-align:center;">
                <h2 style="margin:0;">AGROLLANOS</h2>
                <p style="margin:0; font-size:10px;">MANIFIESTO FINALIZADO #${r.id.toString().slice(-4)}</p>
            </div>
            <div style="font-size:11px; margin-top:8px;">
                <div style="display:flex; justify-content:space-between;"><span>Fecha:</span><span>${fmtDate(r.fecha_entrega || r.fecha)}</span></div>
                <div style="display:flex; justify-content:space-between;"><span>Conductor:</span><strong>${r.conductor_asignado}</strong></div>
                <div style="display:flex; justify-content:space-between;"><span>Placa:</span><span>${r.placa_vehiculo}</span></div>
            </div>
            <hr style="border-top:1px dashed #000; margin:8px 0;">
            ${list}
            <hr style="border-top:1px solid #000; margin:8px 0;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:13px;">
                <span>TOTAL CARGA:</span><span>${fmtNum.format(r.total_kg_entregados_real)} Kg</span>
            </div>
            <div style="display:flex; justify-content:space-between; color:#10b981; font-weight:bold; font-size:14px; margin-top:5px; border-top:1px double #000; padding-top:3px;">
                <span>PAGO TOTAL:</span><span>${fmtMoney.format(totalPagado)}</span>
            </div>
            ${r.observaciones ? `<div style="font-size:10px; margin-top:8px; border:1px solid #ddd; padding:4px;"><strong>Obs:</strong> ${r.observaciones}</div>` : ''}
        `;
        document.getElementById('modalTicket').style.display = 'flex';
    }

    function printTicket() {
        const content = document.getElementById('ticketPreviewContent').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><style>body{font-family:'Courier New',monospace;width:76mm;padding:2mm;font-size:12px;}hr{border:none;border-top:1px dashed black;margin:8px 0;}</style></head><body onload="window.print();window.close();">${content}</body></html>`);
        printWindow.document.close();
    }

    async function downloadTicketImage() {
        const ticketElement = document.getElementById('ticketPreviewContent');
        Swal.fire({title: 'Generando...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        try {
            const canvas = await html2canvas(ticketElement, {scale: 2, backgroundColor: "#ffffff"});
            const link = document.createElement('a');
            link.download = `tiquete_agrollanos_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            Swal.close();
        } catch (error) { Swal.fire('Error', 'No se pudo generar imagen', 'error'); }
    }

    /**
     * Exportaci√≥n mejorada a CSV con todos los campos num√©ricos detallados
     */
    function exportHistoryCSV() {
        let csv = "\uFEFFID;Fecha;Ruta;Placa;Conductor;Kg Planificados;Kg Entregados;Tarifa;Comision;Gastos;Total Pago;Observaciones\n";
        filteredData.forEach(r => {
            const gastos = JSON.parse(r.gastos_adicionales || '[]');
            const totalGasto = gastos.reduce((s, g) => s + (parseFloat(g.val) || 0), 0);
            const kgEnt = parseFloat(r.total_kg_entregados_real) || 0;
            const kgPlan = parseFloat(r.total_kg_ruta) || 0;
            const total = parseFloat(r.total_pagar_conductor) || 0;
            const comision = total - totalGasto;
            const tarifa = parseFloat(r.valor_tarifa) || 0;

            const row = [
                r.id,
                fmtDate(r.fecha_entrega || r.fecha),
                r.nombre_ruta,
                r.placa_vehiculo,
                r.conductor_asignado,
                kgPlan,
                kgEnt,
                tarifa,
                comision,
                totalGasto,
                total,
                (r.observaciones || "").replace(/;/g, ",").replace(/\n/g, " ")
            ];
            csv += row.join(";") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `historial_detallado_agrollanos_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    document.getElementById('btnPrevHist').onclick = () => { if(curPage > 1) { curPage--; renderTable(); } };
    document.getElementById('btnNextHist').onclick = () => { if(curPage < Math.ceil(filteredData.length/itemsPerPage)) { curPage++; renderTable(); } };
    document.querySelectorAll('input, select').forEach(el => el.onchange = applyFilters);

    window.onload = loadHistory;
</script>


</body>
</html>